# bump: clang-format-version /CLANG_FORMAT_VERSION="(.*)"/ https://github.com/llvm/llvm-project.git|semver:*
export CLANG_FORMAT_VERSION="21.1.4"
export ZOPEN_STABLE_TAG="llvmorg-${CLANG_FORMAT_VERSION}"

###
### Build control file for the clang-format port
###

###
### Required Environment Variables
###
export ZOPEN_NAME="clang-format"

export ZOPEN_CATEGORIES="development"

export ZOPEN_RUNTIME_DEPS=""
export ZOPEN_SYSTEM_PREREQ=""

# STABLE Build
export ZOPEN_BUILD_LINE="STABLE"
export ZOPEN_STABLE_URL="https://github.com/llvm/llvm-project.git"
export ZOPEN_STABLE_DEPS="cmake make ninja check_python ccache libxml2 ncurses zlib"


###
### Build stage control environment variables
###


export ZOPEN_CONFIGURE="cmake"
export ZOPEN_CONFIGURE_OPTS="-S llvm -B build -G Ninja \
  --install-prefix \$ZOPEN_INSTALL_DIR/ \
  -DCMAKE_INSTALL_PREFIX=\$ZOPEN_INSTALL_DIR/ \
  -DZLIB_LIBRARY=\"\$ZLIB_HOME/lib/libz.a\" \
  -DLIBXML2_LIBRARY=\"\$LIBXML2_HOME/lib/libxml2.a\" \
  -DLIBXML2_INCLUDE_DIR=\"\$LIBXML2_HOME/include/libxml2/\" \
  -DCMAKE_BUILD_TYPE=Release \
  -DLLVM_ENABLE_PROJECTS=clang \
  -DLLVM_CCACHE_BUILD=ON \
  -DLLVM_TARGETS_TO_BUILD=host"

export ZOPEN_CLEAN="zopen_clean"
export ZOPEN_MAKE="zopen_build"
export ZOPEN_CHECK="zopen_check"
export ZOPEN_INSTALL="zopen_install"

###
### Required user-supplied functions
###

zopen_clean()
{
  # Nothing to clean at this time
}

zopen_build()
{
  cmake --build build --target clang-format -- -j $ZOPEN_NUM_JOBS
}

zopen_check()
{
  # Nothing to check at this time
}

zopen_check_results()
{
  dir="$1"
  pfx="$2"
  chk="$1/$2_check.log"

  failures=0
  totalTests=1

  cat <<ZZ
  actualFailures:$failures
  totalTests:$totalTests
  expectedFailures:0
  expectedTotalTests:1
ZZ
}

zopen_install()
{
  cmake --build build --target install-clang-format-stripped -- -j $ZOPEN_NUM_JOBS
}

zopen_get_version()
{
  "$ZOPEN_INSTALL_DIR/bin/clang-format" --version | awk '{print $3}'
}

